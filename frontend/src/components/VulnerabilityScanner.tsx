import React, { useState, useEffect } from 'react';
import { trivyApi } from '../services/trivyApi';
import '../styles/vulnerability-scanner.css';

interface DockerImage {
  name: string;
  id: string;
  size: number;
}

interface Vulnerability {
  id: string;
  title: string;
  severity: string;
  description: string;
  fix: string;
  references: string[];
}

interface ScanResult {
  status: string;
  image: string;
  timestamp: string;
  summary?: {
    total: number;
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
  vulnerabilities?: Vulnerability[];
  message?: string;
  error?: string;
}

export const VulnerabilityScanner: React.FC = () => {
  const [images, setImages] = useState<DockerImage[]>([]);
  const [loading, setLoading] = useState(false);
  const [scanning, setScanning] = useState<string | null>(null);
  const [scanResults, setScanResults] = useState<ScanResult | null>(null);
  const [expandedVulnerability, setExpandedVulnerability] = useState<string | null>(null);

  useEffect(() => {
    fetchImages();
  }, []);

  const fetchImages = async () => {
    setLoading(true);
    try {
      const result = await trivyApi.getAvailableDockerImages();
      if (result.status === 'success' && result.images) {
        setImages(result.images);
      }
    } catch (error) {
      console.error('Error fetching images:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleScanImage = async (imageName: string) => {
    setScanning(imageName);
    try {
      const result = await trivyApi.scanImageVulnerabilities(imageName);
      setScanResults(result);
    } catch (error) {
      console.error('Error scanning image:', error);
      setScanResults({
        status: 'error',
        image: imageName,
        timestamp: new Date().toISOString(),
        error: 'Failed to scan image'
      });
    } finally {
      setScanning(null);
    }
  };

  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
  };

  const getSeverityColor = (severity: string): string => {
    switch (severity.toUpperCase()) {
      case 'CRITICAL':
        return '#dc2626';
      case 'HIGH':
        return '#ea580c';
      case 'MEDIUM':
        return '#eab308';
      case 'LOW':
        return '#3b82f6';
      default:
        return '#6b7280';
    }
  };

  return (
    <div className="vulnerability-scanner-wrapper">
      <div className="vulnerability-scanner-card">
        <div className="scanner-header">
          <div className="header-title">
            <div className="header-icon">üîç</div>
            <div>
              <h2>Docker Image Vulnerability Scanner</h2>
              <p className="header-subtitle">Powered by Trivy</p>
            </div>
          </div>
          <button 
            onClick={fetchImages} 
            disabled={loading} 
            className="btn-refresh-trivy"
          >
            {loading ? '‚è≥ Loading...' : 'üîÑ Refresh'}
          </button>
        </div>

        <div className="scanner-content">
          {images.length === 0 ? (
            <div className="empty-state">
              <div className="empty-icon">üì¶</div>
              <p className="empty-text">No Docker images found</p>
              <p className="empty-hint">Pull some images or check your Docker daemon</p>
              <button onClick={fetchImages} className="btn-retry-trivy">
                Retry
              </button>
            </div>
          ) : (
            <>
              <div className="images-list">
                <h3 className="list-title">Available Images ({images.length})</h3>
                <div className="images-grid-trivy">
                  {images.map((image) => (
                    <div key={image.id} className="image-card-trivy">
                      <div className="image-header-trivy">
                        <div className="image-name-section">
                          <span className="image-icon">üê≥</span>
                          <div className="image-name-info">
                            <h4>{image.name}</h4>
                            <span className="image-id-trivy">{image.id}</span>
                          </div>
                        </div>
                        <span className="image-size-trivy">{formatFileSize(image.size)}</span>
                      </div>
                      <button
                        onClick={() => handleScanImage(image.name)}
                        disabled={scanning !== null}
                        className="btn-scan-trivy"
                      >
                        {scanning === image.name ? (
                          <>
                            <span className="spinner-trivy"></span>
                            Scanning...
                          </>
                        ) : (
                          'üîé Scan'
                        )}
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}

          {scanResults && (
            <div className="scan-results-section">
              <div className="results-header-trivy">
                <h3>Scan Results</h3>
                <span className="image-name-result">{scanResults.image}</span>
                <span className="timestamp-trivy">
                  {new Date(scanResults.timestamp).toLocaleTimeString()}
                </span>
              </div>

              {scanResults.status === 'error' ? (
                <div className="error-box">
                  <span className="error-icon">‚ùå</span>
                  <div>
                    <p className="error-title">Scan Failed</p>
                    <p className="error-msg">{scanResults.error || scanResults.message}</p>
                  </div>
                </div>
              ) : scanResults.status === 'warning' ? (
                <div className="warning-box">
                  <span className="warning-icon">‚ö†Ô∏è</span>
                  <div>
                    <p className="warning-title">Trivy Not Available</p>
                    <p className="warning-msg">{scanResults.message}</p>
                    <div className="install-hint">
                      Install Trivy: <code>brew install trivy</code> (macOS)
                    </div>
                  </div>
                </div>
              ) : (
                <>
                  <div className="summary-trivy">
                    <div className="summary-item critical-trivy">
                      <span className="count-trivy">{scanResults.summary?.critical || 0}</span>
                      <span className="label-trivy">Critical</span>
                    </div>
                    <div className="summary-item high-trivy">
                      <span className="count-trivy">{scanResults.summary?.high || 0}</span>
                      <span className="label-trivy">High</span>
                    </div>
                    <div className="summary-item medium-trivy">
                      <span className="count-trivy">{scanResults.summary?.medium || 0}</span>
                      <span className="label-trivy">Medium</span>
                    </div>
                    <div className="summary-item low-trivy">
                      <span className="count-trivy">{scanResults.summary?.low || 0}</span>
                      <span className="label-trivy">Low</span>
                    </div>
                  </div>

                  {scanResults.vulnerabilities && scanResults.vulnerabilities.length > 0 ? (
                    <div className="vulnerabilities-list-trivy">
                      <h4 className="vuln-list-title">Found {scanResults.vulnerabilities.length} Vulnerabilities</h4>
                      {scanResults.vulnerabilities.map((vuln) => (
                        <div key={vuln.id} className="vulnerability-item-trivy">
                          <div
                            className="vuln-header-trivy"
                            onClick={() =>
                              setExpandedVulnerability(
                                expandedVulnerability === vuln.id ? null : vuln.id
                              )
                            }
                          >
                            <div className="vuln-main-info">
                              <span
                                className="severity-badge-trivy"
                                style={{ backgroundColor: getSeverityColor(vuln.severity) }}
                              >
                                {vuln.severity}
                              </span>
                              <span className="vuln-id-trivy">{vuln.id}</span>
                            </div>
                            <span className="arrow-trivy">
                              {expandedVulnerability === vuln.id ? '‚ñº' : '‚ñ∂'}
                            </span>
                          </div>
                          {expandedVulnerability === vuln.id && (
                            <div className="vuln-details-trivy">
                              <p className="detail-title">{vuln.title}</p>
                              {vuln.description && (
                                <div className="detail-section">
                                  <strong>Description</strong>
                                  <p>{vuln.description}</p>
                                </div>
                              )}
                              {vuln.fix && (
                                <div className="detail-section">
                                  <strong>Fix</strong>
                                  <p>{vuln.fix}</p>
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="success-box">
                      <span className="success-icon">‚úÖ</span>
                      <p className="success-msg">No vulnerabilities found!</p>
                    </div>
                  )}
                </>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

