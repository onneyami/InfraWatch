#!/usr/bin/env python3
"""
InfraWatch CLI - Infrastructure Monitoring System
A unified command-line interface replacing individual make commands
"""
import sys
import os
from pathlib import Path

# Try to find InfraWatch project root
project_root = None

# 1. Check environment variable first
if env_path := os.environ.get("INFRAWATCH_ROOT"):
    candidate = Path(env_path)
    if (candidate / "Makefile").exists():
        project_root = candidate

# 2. Check current working directory
if not project_root and (Path.cwd() / "Makefile").exists():
    project_root = Path.cwd()

# 3. Check parent directories (up to 5 levels)
if not project_root:
    current = Path.cwd()
    for _ in range(5):
        if (current / "Makefile").exists() and (current / "frontend").exists():
            project_root = current
            break
        current = current.parent

# 4. Check common installation paths
if not project_root:
    common_paths = [
        Path.home() / "Documents" / "InfraWatch_2.0" / "InfraWatch",
        Path.home() / "Documents" / "InfraWatch",
        Path.home() / "InfraWatch",
        Path("/opt/infrawatch"),
        Path("/usr/local/infrawatch"),
    ]
    
    for path in common_paths:
        if (path / "Makefile").exists():
            project_root = path
            break

# If still not found, default to current directory
if not project_root:
    project_root = Path.cwd()

# Set environment variable for subprocesses
os.environ["INFRAWATCH_ROOT"] = str(project_root)
sys.path.insert(0, str(project_root))

# Import and run CLI
try:
    from infrawatch_cli import main
    sys.exit(main())
except ImportError as e:
    print(f"Error: Could not load InfraWatch CLI", file=sys.stderr)
    print(f"Project root: {project_root}", file=sys.stderr)
    print(f"Error details: {e}", file=sys.stderr)
    print(f"\nTry setting environment variable:", file=sys.stderr)
    print(f"  export INFRAWATCH_ROOT=/path/to/InfraWatch", file=sys.stderr)
    sys.exit(1)
